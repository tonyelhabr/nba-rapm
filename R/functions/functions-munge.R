
.separate_lineup <-
  function(play_by_play, col, prefix = "x", suffix = 1:5, sep = "-") {
    play_by_play %>%
      separate(!!enquo(col), into = paste0(prefix, suffix), sep = sep)
  }

.get_cols_players_summary_calc <-
  function(...) {

  }


.summarise_players <-
  function(...,
           play_by_play,
           path_players_summary_calc = config$path_players_summary_calc,
           path_teams_summary_calc = config$path_teams_summary_calc,
           debug = config$debug) {

    .f_summarise <-
      function(.data) {
        .data %>%
          group_by(id_game, id_player, side = side) %>%
          summarise(
            poss_calc = n(),
            mp_calc = sum(mp),
            pts_calc = sum(pts)
          ) %>%
          ungroup()
      }
    players_game_logs_calc <-
      bind_rows(
        play_by_play %>%
          filter(side == "o") %>%
          .f_summarise(),
        play_by_play %>%
          filter(side == "d") %>%
          .f_summarise()
      ) %>%
      arrange(id_game, id_player)

    players_game_logs_calc_tidy <-
      players_game_logs_calc %>%
      gather(metric, value, matches("_calc$"))

    players_game_logs_calc_debug <-
      left_join(
        players_game_logs_calc_tidy %>%
          unite(metric_side, metric, side, sep = "_") %>%
          spread(metric_side, value),
        players_game_logs_calc_tidy %>%
          group_by(id_game, id_player, metric) %>%
          summarise_at(vars(value), funs(sum)) %>%
          ungroup() %>%
          spread(metric, value),
        by = c("id_game", "id_player")
      ) %>%
      mutate(pm_calc = pts_calc_o - pts_calc_d) %>%
      arrange(id_game, id_player)

    if(FALSE) {
      players_game_logs_nbastatr <-
        .try_import_players_game_logs_nbastatr(season = .SEASON)
    } else {
      players_game_logs_nbastatr <-
        .try_import_players_game_logs_nbastatr(...)
    }

    players_game_logs_nbastatr_slim <-
      players_game_logs_nbastatr %>%
      select(
        id_game,
        date_game,
        id_team,
        # name_team,
        slug_team,
        slug_opponent,
        id_player,
        name_player,
        mp_game_logs_nbastatr = minutes,
        pm_game_logs_nbastatr = plusminus
      )

    players_game_logs_debug <-
      players_game_logs_calc_debug %>%
      left_join(
        players_game_logs_nbastatr_slim,
        by = c("id_player", "id_game")
      ) %>%
      arrange(id_game, id_team, id_player) %>%
      mutate(
        mp_diff = mp_calc - mp_game_logs_nbastatr,
        pm_diff = pm_calc - pm_game_logs_nbastatr
      ) %>%
      select(
        id_game,
        id_player,
        slug_team,
        slug_opponent,
        name_player,
        poss_calc,
        mp_calc,
        mp_game_logs_nbastatr,
        mp_diff,
        pts_calc_o,
        pts_calc_d,
        pm_calc,
        pm_game_logs_nbastatr,
        pm_diff
      )

    # TODO: Should probably exclude the inaccurate `pm` results identified
    # with `players_game_logs_debug`.
    if(FALSE) {
      players_game_logs_debug %>%
        filter(id_game == .ID_GAME_DEBUG)
      players_game_logs_debug %>%
        ggplot(aes(x = pm_calc)) +
        geom_histogram()
      players_game_logs_debug %>%
        ggplot(aes(x = pm_diff)) +
        geom_histogram()
      players_game_logs_debug %>%
        select(pm_calc, pm_game_logs_nbastatr) %>%
        corrr::correlate()
      players_game_logs_debug %>% arrange(desc(abs(pm_diff)))
    }

    if(debug) {
      .export_data_from_path(
        # ...,
        season = .SEASON,
        data = players_game_logs_debug,
        path = glue::glue("data/debug/players_game_logs_debug.csv")
      )
    }

    players_summary_calc_base <-
      players_game_logs_calc %>%
      group_by(id_player, side) %>%
      summarise(
        gp_calc = n(),
        poss_calc = sum(poss_calc),
        mp_calc = sum(mp_calc),
        pts_calc = sum(pts_calc)
      ) %>%
      ungroup() %>%
      gather(metric, value, matches("_calc$"))

    if(FALSE) {
      players_nbastatr <-
        .try_import_players_nbastatr(season = .SEASON)
    } else {
      players_nbastatr <-
        .try_import_players_nbastatr(...)
    }
    cols_players_summary_calc <-
      c("id_player",
        "name_player",
        paste0("gp", "_calc_total"),
        paste0("poss", c("_calc_o", "_calc_d", "_calc_total")),
        paste0("mp", c("_calc_o", "_calc_d", "_calc_total")),
        paste0("pts", c("_calc_o", "_calc_d", "_o_per100_calc")),
        "pm_calc"
      )
    players_summary_calc <-
      players_summary_calc_base %>%
      unite(metric, metric, side) %>%
      spread(metric, value) %>%
      mutate(
        poss_calc_total = poss_calc_o + poss_calc_d,
        mp_calc_total = mp_calc_o + mp_calc_d,
        pm_calc = pts_calc_o - pts_calc_d
      ) %>%
      mutate(
        pts_o_per100_calc = 100 * pts_calc_o / poss_calc_o
      ) %>%
      rename(gp_calc_total = gp_calc_o) %>%
      select(-gp_calc_d) %>%
      left_join(
        players_nbastatr %>% select(id_player, name_player),
        by = "id_player"
      ) %>%
      arrange(desc(pm_calc)) %>%
      select(one_of(cols_players_summary_calc))

    if(FALSE) {
      players_summary_nbastatr <-
        .try_import_players_summary_nbastatr(season = .SEASON)
    } else {
      players_summary_nbastatr <-
        .try_import_players_summary_nbastatr(...)
    }

    players_summary_nbastatr_slim <-
      players_summary_nbastatr %>%
      select(
        id_player = id_player_nba,
        name_player_summary_nbastatr = name_player_bref,
        gp_summary_nbastatr = count_games,
        mp_summary1_nbastatr = minutes,
        mp_summary2_nbastatr = minutes_totals
      )

    players_game_logs_nbastatr_slim_summ <-
      players_game_logs_nbastatr_slim %>%
      group_by(id_player, name_player) %>%
      summarise(
        gp_game_logs_nbastatr = n(),
        mp_game_logs_nbastatr = sum(mp_game_logs_nbastatr),
        pm_game_logs_nbastatr = sum(pm_game_logs_nbastatr)
      ) %>%
      ungroup() %>%
      arrange(id_player)

    cols_players_summary_calc_debug <-
      c("id_player",
        paste0("name_player", c("", "_summary_nbastatr")),
        paste0("gp", c("_calc_total", "_summary_nbastatr")),
        paste0("poss", c("_calc_o", "_calc_d", "_calc_total")),
        paste0("mp",
               c(c("_calc_o", "_calc_d", "_calc_total"),
                 "_game_logs_nbastatr",
                 "_summary1_nbastatr",
                 "_summary2_nbastatr")),
        paste0("pts", c("_calc_o", "_calc_d", "_o_per100_calc")),
        paste0("pm", c("_calc", "_game_logs_nbastatr"))
      )

    players_summary_debug <-
      players_summary_calc %>%
      left_join(
        players_game_logs_nbastatr_slim_summ,
        by = c("id_player", "name_player")
      ) %>%
      left_join(
        players_summary_nbastatr_slim,
        by = c("id_player")
      ) %>%
      arrange(desc(pm_calc)) %>%
      select(cols_players_summary_calc_debug)

    if(debug) {
      .export_data_from_path(
        # ...,
        season = .SEASON,
        data = players_summary_debug,
        path = glue::glue("data/debug/players_summary_debug.csv")
      )
    }

    path_export <-
      .export_data_from_path(
        ...,
        data = players_summary_calc,
        path = path_players_summary_calc,
      )

    invisible(players_summary_calc)
  }

.summarise_teams <-
  function(...,
           players_summary_calc,
           path_teams_summary_calc = config$path_teams_summary_calc,
           debug = config$debug) {

      if(FALSE) {
        players_nbastatr <- .try_import_players_nbastatr(season = .SEASON)
      } else {
        players_nbastatr <- .try_import_players_nbastatr(...)
      }

      players_summary_calc_aug <-
        players_summary_calc %>%
        left_join(
          players_nbastatr %>% select(id_player, id_team, team_name),
          by = c("id_player" = "id_player")
        )

      teams_summary_calc <-
        players_summary_calc_aug %>%
        group_by(id_team, team_name) %>%
        summarise_if(is.numeric, funs(sum)) %>%
        ungroup() %>%
        arrange(id_team, team_name)

      if(FALSE) {
        teams_summary_nbastatr <- .try_import_teams_summary_nbastatr(season = .SEASON)
      } else {
        teams_summary_nbastatr <- .try_import_teams_summary_nbastatr(...)
      }

      teams_summary_nbastatr_slim <-
        teams_summary_nbastatr %>%
        select(
          id_team,
          gp_summary_nbastatr = gp,
          pts_summary_nbastatr = pts
        )

      # TODO: Re-arrange the columns to closer to those of similar names.
      teams_summary_debug <-
        teams_summary_calc %>%
        left_join(
          teams_summary_nbastatr_slim,
          by = c("id_team")
        ) %>%
        arrange(desc(pm_calc))

      if(debug) {
        .export_data_from_path(
          # ...,
          season = .SEASON,
          data = teams_summary_debug,
          path = glue::glue("data/debug/teams_summary_debug.csv")
        )
      }
    invisible(players_summary_calc)
  }

.filter_play_by_play <-
  function(..., play_by_play, players_summary_calc, poss_min, gp_min, mp_min) {

    play_by_play %>%
      semi_join(
        players_summary_calc %>%
          filter(
            poss_calc_total >= poss_min,
            gp_calc_total >= gp_min,
            mp_calc_total >= mp_min
          ),
        by = "id_player"
      )
  }

.widen_data_byside <-
  function(...,
           play_by_play,
           side,
           path_possession_data_side,
           debug = config$debug) {

    if(FALSE) {
      side <- "o"
    }
    .validate_side(side)

    dups_n <-
      play_by_play %>%
      filter(side == !!side) %>%
      count(rn, xid_player, sort = TRUE) %>%
      filter(n > 1L)

    if(debug) {

      n_dups <- nrow(dups_n)
      if(n_dups > 0L) {
        .display_warning(
          glue::glue(
            "There are {n_dups} rows with more than one player-side-possession combination ",
            "(i.e. a player appears in a lineup more than once on a single possession)."
          ),
          ...
        )

        if(FALSE) {
          players_nbastatr <-
            .try_import_players_nbastatr(season = .SEASON)
        } else {
          players_nbastatr <-
            .try_import_players_nbastatr(...)
        }

        dups_n_aug <-
          dups_n %>%
          mutate(
            id_player = xid_player %>% str_replace("^%s", "") %>% as.integer()
          ) %>%
          left_join(
            players_nbastatr %>% select(id_player, name_player),
            by = c("id_player")
          )

        path_export <-
          .export_data_from_path(
            # ...,
            season = .SEASON,
            data = dups_n_aug,
            path = glue::glue("data/debug/n_dups.csv"),
          )
      }

    }

    if(FALSE) {
      xid_players <-
        play_by_play %>%
        filter(side == !!side) %>%
        anti_join(dups_n, by = c("rn", "xid_player")) %>%
        arrange(xid_player) %>%
        count(xid_player)
      xid_players_filt <-
        xid_players %>%
        slice(1:50)
    }

    possession_data <-
      play_by_play %>%
      # filter(str_detect(xid_player, paste0("^", side))) %>%
      filter(side == !!side) %>%
      anti_join(dups_n, by = c("rn", "xid_player")) %>%
      arrange(rn, xid_player) %>%
      select(rn, xid_player, pts, mp, dummy) %>%
      # semi_join(xid_players_filt) %>%
      spread(xid_player, dummy, fill = 0L) %>%
      select(-rn) %>%
      mutate(poss = 1L) %>%
      group_by_at(vars(-pts, -poss)) %>%
      summarise_at(vars(pts, poss), funs(sum)) %>%
      ungroup() %>%
      select(pts, poss, everything()) %>%
      mutate(pts = 100 * pts / poss)

    if(FALSE) {
      possession_data %>% arrange(desc(pts))
      possession_data %>% count(poss) %>% arrange(poss)
      possession_data %>% count(poss) %>% arrange(desc(poss))

      possession_data <-
        possession_data %>%
        # filter(poss > 1) %>%
        # filter(pts > 2) %>%

        filter(abs(pts) <= 500) %>%
        select(-poss)
    }

    path_export <-
      .export_data_from_path(
        ...,
        data = possession_data,
        path = path_possession_data_side
      )

    invisible(possession_data)
  }

munge_play_by_play <-
  function(...,
           path_play_by_play = config$path_play_by_play,
           path_possession_data_o = config$path_possession_data_o,
           path_possession_data_d = config$path_possession_data_d,
           debug = config$debug) {

    will_skip <-
      .try_skip(
        ...,
        path_reqs =
          c(
            path_play_by_play
          ),
        path_deps =
          c(
            path_possession_data_o,
            path_possession_data_d
          )
      )
    if(will_skip) {
      return(invisible(NULL))
    }

    play_by_play_import <-
      .import_data_from_path(
        ...,
        path = path_play_by_play
      )

    if(FALSE) {
      play_by_play_import <-
        .import_data_from_path(season = .SEASON, path = config$path_play_by_play)
    }

    play_by_play_join <-
      full_join(
        play_by_play_import %>%
          filter(is_off1) %>%
          select(
            rn1 = rn,
            id_game,
            is_home = is_home1,
            # is_off = is_off1,
            pts = pts1,
            mp,
            id_team_o = id_team1,
            id_team_d = id_team2,
            slug_o = slug_team1,
            slug_d = slug_team2,
            lineup_o = lineup1,
            lineup_d = lineup2
          ),
        play_by_play_import %>%
          mutate(is_home2 = !is_home1, is_off2 = !is_off1) %>%
          filter(is_off2) %>%
          select(
            rn2 = rn,
            id_game,
            is_home = is_home2,
            # is_off = is_off2,
            pts = pts2,
            mp,
            id_team_o = id_team2,
            id_team_d = id_team1,
            slug_o = slug_team2,
            slug_d = slug_team1,
            lineup_o = lineup2,
            lineup_d = lineup1
          )
      ) %>%
      mutate(rn = coalesce(rn1, rn2)) %>%
      select(-matches("^rn[12]$")) %>%
      select(rn, everything()) %>%
      arrange(rn)

    play_by_play_sep <-
      play_by_play_join %>%
      .separate_lineup(lineup_o, suffix = 1:5) %>%
      .separate_lineup(lineup_d, suffix = 6:10) %>%
      mutate_at(vars(matches("^x")), funs(as.integer))

    play_by_play_tidy <-
      play_by_play_sep %>%
      group_by(id_game) %>%
      mutate(poss_num = row_number()) %>%
      ungroup() %>%
      gather(dummy, id_player, matches("^x")) %>%
      select(-dummy) %>%
      group_by(id_game, poss_num) %>%
      mutate(player_num = row_number()) %>%
      ungroup() %>%
      # mutate(is_off = if_else(player_num <= 5L, TRUE, FALSE)) %>%
      mutate(side = if_else(player_num <= 5L, "o", "d")) %>%
      arrange(rn, player_num)

    # play_by_play_tidy <-
    #   play_by_play_tidy %>%
    #   mutate(is_team1 = if_else(id_player <= 5L, TRUE, FALSE)) %>%
    #   select(player_num, is_team1, everything())

    if(FALSE) {

      if(FALSE) {
        players_nbastatr <- .try_import_players_nbastatr(season = .SEASON)
      } else {
        players_nbastatr <- .try_import_players_nbastatr(...)
      }

      play_by_play_debug <-
        play_by_play_tidy %>%
        filter(id_game == .ID_GAME_DEBUG) %>%
        # filter(id_game >= 21700001, id_game <= 21700004) %>%
        # filter(slug_team1 == "SAS" | slug_team2 == "SAS") %>%
        # mutate_at(vars(pts12), funs(if_else(is_off1 == 0L, -., .))) %>%
        rename(pts1_calc = pts1, pts2_calc = pts2) %>%
        left_join(
          # To get `name_player`.
          players_nbastatr %>%
            select(id_player, name_player) %>%
            mutate_at(
              vars(name_player),
              funs(paste0(str_sub(., 1, 1), ". ", str_replace_all(., "^.*\\s+", "")))
            ),
          by = c("id_player")
        ) %>%
        arrange(id_game, poss_num)

      play_by_play_debug <-
        play_by_play_debug %>%
        group_by(id_game, poss_num) %>%
        mutate(player_num = row_number()) %>%
        ungroup() %>%
        mutate_at(vars(player_num), funs(sprintf("x%02d", .)))

      .convert_lineup_to_suffix <-
        function(x) {
          x <- rlang::enquo(x)
          x_chr <- rlang::quo_text(x)
          str_sub(x_chr, start = nchar(x_chr))
        }
      .unite_lineup <-
        function(play_by_play_wide,
                 col,
                 ...,
                 prefix_rgx = "x",
                 sep = "-",
                 remove = TRUE) {
          col_quo <- rlang::enquo(col)
          suffix <- .convert_lineup_to_suffix(!!col_quo)
          suffix_rgx <-
            case_when(suffix == "1" ~ "0[1-5]",
                      suffix == "2" ~ "[01][06-9]")
          rgx <- glue::glue("{prefix_rgx}{suffix_rgx}")
          play_by_play_wide %>%
            unite(!!col_quo, matches(rgx), sep = sep, remove = remove, ...)
        }
      play_by_play_debug_wide <-
        play_by_play_debug %>%
        select(id_game, poss_num, pts1_calc, pts2_calc, player_num, name_player) %>%
        spread(player_num, name_player) %>%
        .unite_lineup(lineup1) %>%
        .unite_lineup(lineup2)

      play_by_play_debug <-
        play_by_play_debug %>%
        select(-matches("^(id|name)_player$|^id_team$|^player_num$")) %>%
        group_by(id_game, poss_num) %>%
        filter(row_number() == 1) %>%
        ungroup() %>%
        inner_join(
          play_by_play_debug_wide,
          by = c("id_game", "poss_num", "pts1_calc", "pts2_calc")
        )

      .export_data_from_path(
        # ...,
        season = .SEASON,
        data = play_by_play_debug,
        path = glue::glue("data/debug/play_by_play_munge1_debug.csv")
      )

      .summarise_stint_stats <-
        function(play_by_play, col) {

          col_quo <- enquo(col)
          suffix <- .convert_lineup_to_suffix(!!col_quo)

          col_pts_calc <- glue::glue("pts{suffix}_calc")
          col_pts_calc_sym <- sym(col_pts_calc)

          res <-
            play_by_play %>%
            select(id_game, period, poss_num, mp, pts1_calc, pts2_calc, !!col_quo) %>%
            group_by(id_game, !!col_quo) %>%
            summarise(
              poss_calc = n(),
              mp = sum(mp),
              # !!col_pts_calc_sym := sum(!!col_pts_calc_sym)
              pts1_calc = sum(pts1_calc),
              pts2_calc = sum(pts2_calc)
            ) %>%
            ungroup() %>%
            mutate(pm_calc = pts1_calc - pts2_calc) %>%
            arrange(id_game, desc(mp))

          if(suffix == "2") {
            res <-
              res %>%
              mutate_at(vars(pm_calc), funs(-.))
          }
          res
        }

      stints1_debug <-
        play_by_play_debug %>%
        .summarise_stint_stats(lineup1)

      stints2_debug <-
        play_by_play_debug %>%
        .summarise_stint_stats(lineup2)

      .export_data_from_path(
        # ...,
        season = .SEASON,
        data = stints1_debug,
        path = glue::glue("data/debug/stints1_debug.csv")
      )
      .export_data_from_path(
        # ...,
        season = .SEASON,
        data = stints2_debug,
        path = glue::glue("data/debug/stints2_debug.csv")
      )
    }

    play_by_play <-
      play_by_play_tidy %>%
      mutate(xid_player = sprintf("%s%07d", side, as.integer(id_player))) %>%
      # select(-side) %>%
      mutate(dummy = 1L)


    players_summary_calc <-
      .summarise_players(
        ...,
        play_by_play = play_by_play
      )

    teams_summary_calc <-
      .summarise_teams(
        ...,
        players_summary_calc = players_summary_calc
      )


    play_by_play <-
      .filter_play_by_play(
        ...,
        play_by_play = play_by_play,
        players_summary_calc = players_summary_calc
      )

    .widen_data_byside_partially <-
      purrr::partial(
        .widen_data_byside,
        ...,
        play_by_play = play_by_play
      )

    # browser()
    possession_data_o <-
      .widen_data_byside_partially(
        path_possession_data_side = path_possession_data_o,
        side = "o"
      )

    possession_data_d <-
      .widen_data_byside_partially(
        path_possession_data_side = path_possession_data_d,
        side = "d"
      )

    invisible(
      list(
        possession_data_o = possession_data_o,
        possession_data_d = possession_data_d
      )
    )
  }

auto_munge_play_by_play <-
  purrr::partial(
    munge_play_by_play,
    season = config$season,
    poss_min = config$poss_min,
    gp_min = config$gp_min,
    mp_min = config$mp_min,
    skip = config$skip_munge,
    verbose = config$verbose,
    export = config$export,
    backup = config$backup,
    clean = config$clean,
    n_keep = config$n_keep
  )
